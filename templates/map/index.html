{{ define "map/index.html" }}
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Montreal Map View - Événements publics</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="/static/mapStyle.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/protomaps-leaflet@latest/dist/protomaps-leaflet.min.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script src="/static/L.KML.js" defer></script>
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>

    <script>
        var markupLayer
        var panneLayer
        var map
        const array_chunks = (array, chunk_size) => Array(Math.ceil(array.length / chunk_size)).fill().map((_, index) => index * chunk_size).map(begin => array.slice(begin, begin + chunk_size));

        function addPopupContent(feature, layer) {
            let popupContent = `
                <div id="popup-content" class="popup-content">
                    <h3>${feature.properties.map_object.name}</h3>`

            if (feature.properties.map_object.name != feature.properties.map_object.category) {
                popupContent += `
                <h5>${feature.properties.map_object.category}</h5>`
            }

            if (feature.properties.map_object.description) {
                if (feature.properties.map_object.description.length > 100) {
                    popupContent += `
                <p>${feature.properties.map_object.description.substring(0, 100)}...</p>`
                } else {
                    popupContent += `
                <p>${feature.properties.map_object.description}</p>`
                }
            }

            popupContent += `
            <p>Date: ${feature.properties.date_readable}</p>
            `

            if (feature.properties.event._id) {
                popupContent += `
                        <button
                            class="w3-btn w3-white w3-border w3-border-blue w3-round w3-hover-indigo"
                            hx-trigger="click" hx-get="/event/${feature.properties.event._id}" 
                            hx-target="body"hx-swap="beforeend" 
                            hx-trigger="click"
                            >
                            Plus d'infos
                        </button>
                        <button class="w3-btn w3-white w3-round w3-border w3-border-amber w3-hover-orange" @click="updateDataPointsWithParams('show=${feature.properties.event._id}&event_id=${feature.properties.event._id}&type=helps');$store.showAideLieeCard=true">
                            Aides liées
                        </button>
                        <button @click="openHelpModal('${feature.properties.event._id}')" class="w3-btn w3-white w3-round w3-border w3-border-lime w3-hover-green" {{ if not .ActiveSession }} disabled title="Veuillez vous connecter" {{ end }}> 
                            Aider
                        </button>
                        `
            }
            else if (feature.properties.help._id) {
                popupContent += `
                        <button
                            class="w3-btn w3-white w3-border w3-border-blue w3-round w3-hover-indigo"
                            hx-trigger="click" 
                            hx-get="/help/${feature.properties.help._id}" 
                            hx-target="body"hx-swap="beforeend" 
                            hx-trigger="click">
                            Plus d'infos
                        </button>
                        <button
                            class="w3-btn w3-white w3-border w3-border-blue w3-round w3-hover-indigo"
                            hx-trigger="click" 
                            hx-get="/event/${feature.properties.help.event_id}" 
                            hx-target="body"hx-swap="beforeend" 
                            hx-trigger="click">
                            Evenement lié
                        </button>
                        `
            }

            popupContent += "</div>";
            layer.bindPopup(popupContent);
        }

        function addDataPoints(dataPairs, map) {
            dataPairs.forEach(geoJsonPair => {
                let myIcon = L.divIcon({
                    className: `w3-center w3-text-${geoJsonPair.style.color} w3-${"x".repeat(geoJsonPair.style.iconSize)}large material-symbols-rounded`,
                    html: geoJsonPair.style.icon,
                    popupAnchor: [geoJsonPair.style.iconSize * 4 + 4, -6]
                });
                if (geoJsonPair.geoJson.geometry.type === "Polygon") {
                    geoJsonPair.geoJson.geometry.coordinates = [array_chunks(geoJsonPair.geoJson.geometry.coordinates, 2)];
                }
                L.geoJSON(geoJsonPair.geoJson, {
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, { icon: myIcon });
                    },
                    onEachFeature: addPopupContent,

                }).addTo(map);
            });
        }

        function addPannesOverlay(map) {
            fetch('/get-pannes-overlay')
                .then(response => response.text())
                .then(kmltext => {
                    const parser = new DOMParser();
                    const kml = parser.parseFromString(kmltext, 'text/xml');
                    var kmlLayer = new L.KML(kml);
                    kmlLayer.addTo(map);
                });
        }

        function updateDataPointsWithFilter() {
            let data = Alpine.store('filters');
            let params = new URLSearchParams();
            let noFilter = true;
            Object.keys(data.categories).forEach(key => {
                if (data.categories[key]) {
                    params.append('map_object.category', key);
                    noFilter = false;
                }
            });
            if (noFilter) {
                params.append('map_object.category', '-1');
            }
            noFilter = true;
            Object.keys(data.urgencyLevels).forEach(key => {
                if (data.urgencyLevels[key]) {
                    params.append('urgency_type', key);
                    noFilter = false;
                }
            });
            if (noFilter) {
                params.append('urgency_type', '-1');
            }
            noFilter = true;
            Object.keys(data.dangerLevels).forEach(key => {
                if (data.dangerLevels[key]) {
                    params.append('danger_level', key);
                    noFilter = false;
                }
            });
            if (noFilter) {
                params.append('danger_level', '-1');
            }

            if (data.categories['Panne d\'électricité'] && data.urgencyLevels['1'] && data.dangerLevels['2']) {
                panneLayer.addTo(map);
            } else {
                panneLayer.remove();
            }

            updateDataPointsWithParams(params.toString());
        }

        function updateDataPointsWithParams(params) {
            if (history.pushState) {
                history.pushState(null, null, '/map?' + params);
            }
            urlParams = new URLSearchParams(params);
            fetch('/map-json?' + params)
                .then(response => response.json())
                .then(data => {
                    if (urlParams.get('type') == 'helps') {
                        panneLayer.remove();
                    } else {
                        panneLayer.addTo(map);
                    }
                    markupLayer.clearLayers();
                    addDataPoints(data, markupLayer);
                });
        }

        function openHelpModal(eventId) {
            document.getElementById('eventIdField').value = eventId;
            document.getElementById('helpModal').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function () {
            map = L.map('map').setView([45.5017, -73.5673], 8);
            map.on('popupopen', function (e) {
                htmx.process(document.body)
            })

            var layer = protomapsL.leafletLayer({
                url: 'https://hackqc2024.cedille.club/my_area.pmtiles',
                theme: 'light',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            })
            layer.addTo(map)

            markupLayer = L.layerGroup().addTo(map);
            panneLayer = L.layerGroup();

            let data = JSON.parse("{{ .MapItemsJson }}")
            addPannesOverlay(panneLayer)
            addDataPoints(data, markupLayer)
            params = new URLSearchParams(window.location.search);

            filters = Alpine.store('filters')
            if (filters.categories['Panne d\'électricité'] && filters.urgencyLevels['1'] && filters.dangerLevels['2']
                && params.get('type') != 'helps') {
                panneLayer.addTo(map);
            }
        });

        document.addEventListener('alpine:init', () => {
            Alpine.store('filters', {
                categories: {
                    {{ range .EventCategories }}
                    '{{ .Value }}': true,
            {{ end }}
            {{ range .HelpCategories }}
            '{{ .Value }}': true,
            {{ end }}
                },
            urgencyLevels: {
                    {{ range .UrgencyLevels }}
            '{{ .Value }}': true,
            {{ end }}
                },
            dangerLevels: {
                    {{ range .DangerLevels }}
            '{{ .Value }}': true,
            {{ end }}
                },
            eventCategories: [
            {{ range .EventCategories }}
            "{{ .Value }}",
            {{ end }}
        ],
            helpCategories: [
            {{ range .HelpCategories }}
            "{{ .Value }}",
            {{ end }}
        ]
                });

        let params = new URLSearchParams(window.location.search);
        let filters = Alpine.store('filters');
        if (params.has('map_object.category')) {
            Object.keys(filters.categories).forEach((v, k) => {
                filters.categories[v] = params.getAll('map_object.category').includes(v);
            });
        }
        if (params.has('urgency_type')) {
            Object.keys(filters.urgencyLevels).forEach((v, k) => {
                filters.urgencyLevels[v] = params.getAll('urgency_type').includes(v);
            });
        }
        if (params.has('danger_level')) {
            Object.keys(filters.dangerLevels).forEach((v, k) => {
                filters.dangerLevels[v] = params.getAll('danger_level').includes(v);
            });
        }
        Alpine.store('filters', filters);
        Alpine.store('showAideLieeCard', params.has('event_id') && params.get('type') == 'helps');

        });

        function isAllSelected(categoryArray, filter) {
            filters = Alpine.store("filters")
            return categoryArray.every(v => filters[filter][v] == true)
        }
    </script>
</head>

<body>

    {{ template "components/navbar" . }}

    <h2 class="w3-center">Événements d'urgence</h2>
    <div class="w3-container">
        <div class="w3-card w3-auto w3-round-large" style="width: 90vw;max-width: none;">
            <div x-data="{ active: '' }">
                <span class="w3-margin-left"><b>Filtres</b></span>
                <button @click="active = active == 'categories' ? '' : 'categories'"
                    class="w3-btn w3-border w3-border-gray w3-round-xlarge w3-margin"
                    x-bind:class="active == 'categories' ? 'w3-blue' : 'w3-white'">
                    Catégories
                    <span
                        x-bind:class="isAllSelected(Object.keys($store.filters.categories), 'categories') ? 'w3-hide' : ''"
                        class="w3-badge w3-gray">1</span>
                </button>

                <button @click="active = active == 'urgency' ? '' : 'urgency'"
                    class="w3-btn w3-border w3-border-gray w3-round-xlarge w3-margin"
                    x-bind:class="active == 'urgency' ? 'w3-blue' : 'w3-white'">
                    Urgence
                    <span
                        x-bind:class="isAllSelected(Object.keys($store.filters.urgencyLevels), 'urgencyLevels') ? 'w3-hide' : ''"
                        class="w3-badge w3-gray">1</span>
                </button>

                <button @click="active = active == 'dangerLevel' ? '' : 'dangerLevel'"
                    class="w3-btn w3-border w3-border-gray w3-round-xlarge w3-margin"
                    x-bind:class="active == 'dangerLevel' ? 'w3-blue' : 'w3-white'">
                    Danger
                    <span
                        x-bind:class="isAllSelected(Object.keys($store.filters.dangerLevels), 'dangerLevels') ? 'w3-hide' : ''"
                        class="w3-badge w3-gray">1</span>
                </button>

                <!-- Categories -->
                <div x-show="active == 'categories'"
                    x-data="{ showAllEvents: isAllSelected($store.filters.eventCategories, 'categories'),    toggleEvents() { this.showAllEvents = !this.showAllEvents ; $store.filters.eventCategories.forEach(v => $store.filters.categories[v] = this.showAllEvents) },
                              showAllHelps: isAllSelected($store.filters.helpCategories, 'categories'), toggleHelps() { this.showAllHelps = !this.showAllHelps ; $store.filters.helpCategories.forEach(v => $store.filters.categories[v] = this.showAllHelps) } }"
                    class="w3-panel w3-padding-32 w3-topbar w3-border-blue" style="display: none;">
                    <div x-data>
                        <div class="w3-border-bottom w3-border-gray">
                            <h6 class="w3-text-blue">Événements</h6>
                            <button class="w3-btn w3-margin-right w3-margin-bottom w3-round-large"
                                x-bind:class="isAllSelected($store.filters.eventCategories, 'categories') ? 'w3-border-blue w3-border' : 'w3-blue'"
                                @click="toggleEvents(); updateDataPointsWithFilter()"
                                x-text="isAllSelected($store.filters.eventCategories, 'categories') ? 'Tout déselectionner' : 'Tout sélectionner'"
                                >Tout sélectionner</button>
                            {{ range .EventCategories }}
                            <button
                                class="w3-btn w3-border w3-border-blue w3-margin-right w3-margin-bottom w3-round-large"
                                x-bind:class="$store.filters.categories['{{ .Value |  escapeSingleQuotes}}'] ? 'w3-blue' : 'w3-white'"
                                @click="$store.filters.categories['{{ .Value |  escapeSingleQuotes }}'] = !$store.filters.categories['{{ .Value |  escapeSingleQuotes }}']; updateDataPointsWithFilter(), showAllEvents = isAllSelected($store.filters.eventCategories, 'categories')"
                                x-text="'{{ .Name |  escapeSingleQuotes }}'"></button>
                            {{ end }}
                        </div>
                        <div>
                            <h6 class="w3-text-blue">Aides</h6>
                            <button class="w3-btn w3-margin-right w3-margin-bottom w3-round-large"
                                x-bind:class="isAllSelected($store.filters.helpCategories, 'categories') ? 'w3-border-blue w3-border' : 'w3-blue'"
                                @click="toggleHelps(); updateDataPointsWithFilter()"
                                x-text="isAllSelected($store.filters.helpCategories, 'categories') ? 'Tout déselectionner' : 'Tout sélectionner'"
                                >Tout sélectionner</button>

                            {{ range .HelpCategories }}
                            <button
                                class="w3-btn w3-border w3-border-blue w3-margin-right w3-margin-bottom w3-round-large"
                                x-bind:class="$store.filters.categories['{{ .Value |  escapeSingleQuotes}}'] ? 'w3-blue' : 'w3-white'"
                                @click="$store.filters.categories['{{ .Value |  escapeSingleQuotes }}'] = !$store.filters.categories['{{ .Value |  escapeSingleQuotes }}']; updateDataPointsWithFilter(), showAllHelps = isAllSelected($store.filters.helpCategories, 'categories')"
                                x-text="'{{ .Name |  escapeSingleQuotes }}'"></button>
                            {{ end }}
                        </div>
                    </div>
                </div>

                <!-- Urgency -->
                <div x-show="active == 'urgency'"
                    x-data="{ showAll: isAllSelected(Object.keys($store.filters.urgencyLevels), 'urgencyLevels'), toggle() { this.showAll = !this.showAll ; Object.keys($store.filters.urgencyLevels).forEach(v => $store.filters.urgencyLevels[v] = this.showAll) } }"
                    class="w3-panel w3-padding-32 w3-topbar w3-border-blue" style="display: none;">
                    <div x-data>
                        <button class="w3-btn w3-margin-right w3-margin-bottom w3-round-large"
                            x-bind:class="isAllSelected(Object.keys($store.filters.urgencyLevels), 'urgencyLevels') ? 'w3-border-blue w3-border' : 'w3-blue'"
                            @click="toggle(); updateDataPointsWithFilter()"
                            x-text="isAllSelected(Object.keys($store.filters.urgencyLevels), 'urgencyLevels') ? 'Tout déselectionner' : 'Tout sélectionner'"
                            >Tout sélectionner</button>
                        {{ range .UrgencyLevels }}
                        <button class="w3-btn w3-border w3-border-blue w3-margin-right w3-margin-bottom w3-round-large"
                            x-bind:class="$store.filters.urgencyLevels['{{ .Value |  escapeSingleQuotes}}'] ? 'w3-blue' : 'w3-white'"
                            @click="$store.filters.urgencyLevels['{{ .Value |  escapeSingleQuotes }}'] = !$store.filters.urgencyLevels['{{ .Value |  escapeSingleQuotes }}']; updateDataPointsWithFilter(), showAll = isAllSelected(Object.keys($store.filters.urgencyLevels), 'urgencyLevels')"
                            x-text="'{{ .Name |  escapeSingleQuotes }}'"></button>
                        {{ end }}
                    </div>
                </div>

                <!-- Danger Level -->
                <div x-show="active == 'dangerLevel'"
                    x-data="{ showAll: isAllSelected(Object.keys($store.filters.dangerLevels), 'dangerLevels'), toggle() { this.showAll = !this.showAll ; Object.keys($store.filters.dangerLevels).forEach(v => $store.filters.dangerLevels[v] = this.showAll) } }"
                    class="w3-panel w3-padding-32 w3-topbar w3-border-blue" style="display: none;">
                    <div x-data>
                        <button class="w3-btn w3-margin-right w3-margin-bottom w3-round-large"
                            x-bind:class="isAllSelected(Object.keys($store.filters.dangerLevels), 'dangerLevels') ? 'w3-border-blue w3-border' : 'w3-blue'"
                            @click="toggle(); updateDataPointsWithFilter()"
                            x-text="isAllSelected(Object.keys($store.filters.dangerLevels), 'dangerLevels') ? 'Tout déselectionner' : 'Tout sélectionner'"
                            >Tout sélectionner</button>
                        {{ range .DangerLevels }}
                        <button class="w3-btn w3-border w3-border-blue w3-margin-right w3-margin-bottom w3-round-large"
                            x-bind:class="$store.filters.dangerLevels['{{ .Value |  escapeSingleQuotes}}'] ? 'w3-blue' : 'w3-white'"
                            @click="$store.filters.dangerLevels['{{ .Value |  escapeSingleQuotes }}'] = !$store.filters.dangerLevels['{{ .Value |  escapeSingleQuotes }}']; updateDataPointsWithFilter(), showAll = isAllSelected(Object.keys($store.filters.dangerLevels), 'dangerLevels')"
                            x-text="'{{ .Name |  escapeSingleQuotes }}'"></button>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-data>
        <div id="aideLieeCard" class="w3-card w3-margin-top w3-auto w3-round-large"
            style="width: 90vw;max-width: none;display: none" x-show="$store.showAideLieeCard">
            <div class="w3-container w3-padding">
                <!-- Explain this mode-->
                <p>Ce mode permet de visualiser les aides liées à un événement.
                    <!-- Button to go back to all  -->
                    <a class="w3-btn w3-blue w3-margin-left w3-round-large" href="/map">Retourner à la carte</a>
                </p>
            </div>
        </div>
    </div>

    <div id="map" class="w3-card w3-margin-top w3-auto w3-round-large"
        style="width: 90vw;height: 70vh;max-width: none;"></div>

    <div class="w3-margin-top w3-auto w3-round-large"
        style="width: 90vw; max-width: none; border: none; display: flex; justify-content: start; align-items: center;">
        <button onclick="document.getElementById('eventModal').style.display='block'"
            class="w3-btn w3-teal w3-round-xlarge" {{ if not .ActiveSession }} disabled title="Veuillez vous connecter"
            {{ end }}>Créer un événement</button>
        <a href="/map" class="w3-btn w3-teal w3-round-xlarge" style="margin-left: 10px;">Réinitialiser les filtres</a>
    </div>


    <!-- END OF PAGE -->

    <div id="helpModal" class="w3-modal">
        <div class="w3-modal-content w3-animate-opacity w3-card-8">
            <header class="w3-container w3-teal">
                <span onclick="document.getElementById('helpModal').style.display='none'"
                    class="w3-button w3-large w3-display-topright">&times;</span>
                <h2>Soumettre une demande d'aide</h2>
            </header>

            {{ template "forms/helpForm.html" . }}

            <footer class="w3-container w3-teal">
                <p>Merci pour votre contribution!</p>
            </footer>
        </div>
    </div>

    <div id="eventModal" class="w3-modal">
        <div class="w3-modal-content w3-animate-opacity w3-card-8 w3-round-xlarge">
            <header class="w3-container" style="height: 0;">
                <span onclick="document.getElementById('eventModal').style.display='none'"
                    class="w3-button w3-teal w3-large w3-display-topright w3-round-large w3-margin">&times;</span>
                <h2>Soumettre un événement</h2>
            </header>

            {{ template "forms/eventForm.html" . }}

            <footer class="w3-container w3-teal">
                <p>Merci pour votre contribution!</p>
            </footer>
        </div>
    </div>
</body>

</html>
{{ end }}