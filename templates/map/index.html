{{ define "map/index.html" }}
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Montreal Map View - Événements publics</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="static/favicon.svg" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="/static/mapStyle.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/protomaps-leaflet@latest/dist/protomaps-leaflet.min.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script src="/static/L.KML.js" defer></script>
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>

    <script>
        var markupLayer
        var panneLayer
        var map
        const array_chunks = (array, chunk_size) => Array(Math.ceil(array.length / chunk_size)).fill().map((_, index) => index * chunk_size).map(begin => array.slice(begin, begin + chunk_size));

        function addPopupContent(feature, layer) {
            let popupContent = `
                <div id="popup-content" class="popup-content">
                    <h3>${feature.properties.map_object.name}</h3>
                    <h5>${feature.properties.map_object.category}</h5>
                    <p>${feature.properties.map_object.description.substring(0, 100)}...</p>
                    <p>Date: ${feature.properties.map_object.date}</p>
                    `

            if (feature.properties.event._id) {
                popupContent += `
                        <button
                            class="w3-btn w3-white w3-border w3-border-blue w3-round w3-hover-indigo"
                            hx-trigger="click" hx-get="/event/${feature.properties.event._id}" 
                            hx-target="body"hx-swap="beforeend" 
                            hx-trigger="click"
                            >
                            Plus d'infos
                        </button>
                        <button class="w3-btn w3-white w3-round w3-border w3-border-amber w3-hover-orange" @click="updateDataPointsWithParams('show=${feature.properties.event._id}&event_id=${feature.properties.event._id}&type=helps')">
                            Aides liées
                        </button>
                        <button @click="openHelpModal('${feature.properties.event._id}')" class="w3-btn w3-white w3-round w3-border w3-border-lime w3-hover-green" {{ if not .ActiveSession }} disabled title="Veuillez vous connecter" {{ end }}> 
                            Aider
                        </button>
                        `
            }
            else if (feature.properties.help._id) {
                popupContent += `
                        <button
                            class="w3-btn w3-white w3-border w3-border-blue w3-round w3-hover-indigo"
                            hx-trigger="click" 
                            hx-get="/help/${feature.properties.help._id}" 
                            hx-target="body"hx-swap="beforeend" 
                            hx-trigger="click">
                            Plus d'infos
                        </button>
                        <button
                            class="w3-btn w3-white w3-border w3-border-blue w3-round w3-hover-indigo"
                            hx-trigger="click" 
                            hx-get="/event/${feature.properties.help.event_id}" 
                            hx-target="body"hx-swap="beforeend" 
                            hx-trigger="click">
                            Evenement lié
                        </button>
                        `
            }

            popupContent += "</div>";
            layer.bindPopup(popupContent);
        }

        function addDataPoints(dataPairs, map) {
            dataPairs.forEach(geoJsonPair => {
                let myIcon = L.divIcon({
                    className: `w3-center w3-text-${geoJsonPair.style.color} w3-${"x".repeat(geoJsonPair.style.iconSize)}large material-symbols-rounded`,
                    html: geoJsonPair.style.icon,
                    popupAnchor: [geoJsonPair.style.iconSize * 4 + 4, -6]
                });
                if (geoJsonPair.geoJson.geometry.type === "Polygon") {
                    geoJsonPair.geoJson.geometry.coordinates = [array_chunks(geoJsonPair.geoJson.geometry.coordinates, 2)];
                }
                L.geoJSON(geoJsonPair.geoJson, {
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, { icon: myIcon });
                    },
                    onEachFeature: addPopupContent,

                }).addTo(map);
            });
        }

        function addPannesOverlay(map) {
            fetch('/get-pannes-overlay')
                .then(response => response.text())
                .then(kmltext => {
                    const parser = new DOMParser();
                    const kml = parser.parseFromString(kmltext, 'text/xml');
                    var kmlLayer = new L.KML(kml);
                    kmlLayer.addTo(map);
                });
        }

        function updateDataPointsWithFilter() {
            let data = Alpine.store('filters');
            let params = new URLSearchParams();
            let noFilter = true;
            Object.keys(data.categories).forEach(key => {
                if (data.categories[key]) {
                    params.append('map_object.category', key);
                    noFilter = false;
                }
            });
            if (noFilter) {
                params.append('map_object.category', '-1');
            }
            noFilter = true;
            Object.keys(data.urgencyLevels).forEach(key => {
                if (data.urgencyLevels[key]) {
                    params.append('urgency_type', key);
                    noFilter = false;
                }
            });
            if (noFilter) {
                params.append('urgency_type', '-1');
            }
            noFilter = true;
            Object.keys(data.dangerLevels).forEach(key => {
                if (data.dangerLevels[key]) {
                    params.append('danger_level', key);
                    noFilter = false;
                }
            });
            if (noFilter) {
                params.append('danger_level', '-1');
            }

            if (data.categories['Panne d\'électricité'] && data.urgencyLevels['1'] && data.dangerLevels['2']) {
                panneLayer.addTo(map);
            } else {
                panneLayer.remove();
            }

            updateDataPointsWithParams(params.toString());
        }

        function updateDataPointsWithParams(params) {
            if (history.pushState) {
                history.pushState(null, null, '/map?' + params);
            }
            fetch('/map-json?' + params)
                .then(response => response.json())
                .then(data => {
                    markupLayer.clearLayers();
                    addDataPoints(data, markupLayer);
                });
        }

        function openHelpModal(eventId) {
            document.getElementById('eventIdField').value = eventId;
            document.getElementById('helpModal').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function () {
            map = L.map('map').setView([45.5017, -73.5673], 8);
            map.on('popupopen', function (e) {
                htmx.process(document.body)
            })

            var layer = protomapsL.leafletLayer({
                url: 'https://hackqc2024.cedille.club/my_area.pmtiles',
                theme: 'light',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            })
            layer.addTo(map)

            markupLayer = L.layerGroup().addTo(map);
            panneLayer = L.layerGroup();

            let data = JSON.parse("{{ .MapItemsJson }}")
            addPannesOverlay(panneLayer)
            addDataPoints(data, markupLayer)

            filters = Alpine.store('filters')
            if (filters.categories['Panne d\'électricité'] && filters.urgencyLevels['1'] && filters.dangerLevels['2']) {
                panneLayer.addTo(map);
            }
        });

        document.addEventListener('alpine:init', () => {
            Alpine.store('filters', {
                categories: {
                    {{ range .EventCategories }}
                        '{{ .Value }}': true,
            {{ end }}
            {{ range .HelpCategories }}
            '{{ .Value }}': true,
            {{ end }}
                    },
            urgencyLevels: {
                        {{ range .UrgencyLevels }}
            '{{ .Value }}': true,
            {{ end }}
                    },
            dangerLevels: {
                        {{ range .DangerLevels }}
            '{{ .Value }}': true,
            {{ end }}
                    }
                });

        let params = new URLSearchParams(window.location.search);
        let filters = Alpine.store('filters');
        if (params.has('map_object.category')) {
            Object.keys(filters.categories).forEach((v, k) => {
                filters.categories[v] = params.getAll('map_object.category').includes(v);
            });
        }
        if (params.has('urgency_type')) {
            Object.keys(filters.urgencyLevels).forEach((v, k) => {
                filters.urgencyLevels[v] = params.getAll('urgency_type').includes(v);
            });
        }
        if (params.has('danger_level')) {
            Object.keys(filters.dangerLevels).forEach((v, k) => {
                filters.dangerLevels[v] = params.getAll('danger_level').includes(v);
            });
        }
        Alpine.store('filters', filters);

        });
    </script>
</head>

<body>

    {{ template "components/navbar" . }}

    <h2 class="w3-center">Événements d'urgence</h2>
    <div class="w3-container">
        <div class="w3-card w3-auto w3-round-large" style="width: 90vw;max-width: none;">
            <div x-data="{ active: '' }">
                <button @click="active = active == 'categories' ? '' : 'categories'"
                    class="w3-btn w3-border w3-border-gray w3-round-xlarge w3-margin"
                    x-bind:class="active == 'categories' ? 'w3-blue' : 'w3-white'">
                    Catégories
                </button>

                <button @click="active = active == 'urgency' ? '' : 'urgency'"
                    class="w3-btn w3-border w3-border-gray w3-round-xlarge w3-margin"
                    x-bind:class="active == 'urgency' ? 'w3-blue' : 'w3-white'">
                    Urgence
                </button>

                <button @click="active = active == 'dangerLevel' ? '' : 'dangerLevel'"
                    class="w3-btn w3-border w3-border-gray w3-round-xlarge w3-margin"
                    x-bind:class="active == 'dangerLevel' ? 'w3-blue' : 'w3-white'">
                    Danger
                </button>

                <div x-show="active == 'categories'"
                    x-data="{ showAll: true, toggleCategories() { this.showAll = !this.showAll ; Object.keys($store.filters.categories).forEach(v => $store.filters.categories[v] = this.showAll) } }"
                    class="w3-panel w3-padding-32 w3-topbar w3-border-blue" style="display: none;">
                    <div x-data>
                        <div class="w3-border-bottom w3-border-gray">
                            <button class="w3-btn w3-gray w3-margin-right w3-margin-bottom"
                                @click="toggleCategories(); updateDataPointsWithFilter()">Sélectionner
                                tout</button>
                        </div>
                        <div class="w3-border-bottom w3-border-gray">
                            <h6 class="w3-text-blue">Événements</h6>
                            {{ range .EventCategories }}
                            <button
                                class="w3-btn w3-border w3-border-blue w3-margin-right w3-margin-bottom w3-round-large"
                                x-bind:class="$store.filters.categories['{{ .Value |  escapeSingleQuotes}}'] ? 'w3-blue' : 'w3-white'"
                                @click="$store.filters.categories['{{ .Value |  escapeSingleQuotes }}'] = !$store.filters.categories['{{ .Value |  escapeSingleQuotes }}']; updateDataPointsWithFilter()"
                                x-text="'{{ .Name |  escapeSingleQuotes }}'"></button>
                            {{ end }}
                        </div>
                        <div>
                            <h6 class="w3-text-blue">Aides</h6>
                            {{ range .HelpCategories }}
                            <button
                                class="w3-btn w3-border w3-border-blue w3-margin-right w3-margin-bottom w3-round-large"
                                x-bind:class="$store.filters.categories['{{ .Value |  escapeSingleQuotes}}'] ? 'w3-blue' : 'w3-white'"
                                @click="$store.filters.categories['{{ .Value |  escapeSingleQuotes }}'] = !$store.filters.categories['{{ .Value |  escapeSingleQuotes }}']; updateDataPointsWithFilter()"
                                x-text="'{{ .Name |  escapeSingleQuotes }}'"></button>
                            {{ end }}
                        </div>
                    </div>
                </div>

                <!-- Urgency -->
                <div x-show="active == 'urgency'" class="w3-panel w3-padding-32 w3-topbar w3-border-blue"
                    style="display: none;">
                    <div x-data>
                        <div>
                            <button class="w3-btn w3-gray w3-margin-right w3-margin-bottom"
                                @click="Object.keys($store.filters.urgencyLevels).forEach(v => $store.filters.urgencyLevels[v] = true); updateDataPointsWithFilter()">Sélectionner
                                tout</button>
                            <button class="w3-btn w3-gray w3-margin-right w3-margin-bottom"
                                @click="Object.keys($store.filters.urgencyLevels).forEach(v => $store.filters.urgencyLevels[v] = false); updateDataPointsWithFilter()">Ne
                                sélectionner rien</button>
                        </div>
                        <div></div>
                        {{ range .UrgencyLevels }}
                        <button class="w3-btn w3-border w3-border-blue w3-margin-right w3-margin-bottom w3-round-large"
                            x-bind:class="$store.filters.urgencyLevels['{{ .Value |  escapeSingleQuotes}}'] ? 'w3-blue' : 'w3-white'"
                            @click="$store.filters.urgencyLevels['{{ .Value |  escapeSingleQuotes }}'] = !$store.filters.urgencyLevels['{{ .Value |  escapeSingleQuotes }}']; updateDataPointsWithFilter()"
                            x-text="'{{ .Name |  escapeSingleQuotes }}'"></button>
                        {{ end }}
                    </div>
                </div>

                <!-- Danger Level -->
                <div x-show="active == 'dangerLevel'" class="w3-panel w3-padding-32 w3-topbar w3-border-blue"
                    style="display: none;">
                    <div x-data>
                        <div>
                            <button class="w3-btn w3-gray w3-margin-right w3-margin-bottom"
                                @click="Object.keys($store.filters.dangerLevels).forEach(v => $store.filters.dangerLevels[v] = true); updateDataPointsWithFilter()">Sélectionner
                                tout</button>
                            <button class="w3-btn w3-gray w3-margin-right w3-margin-bottom"
                                @click="Object.keys($store.filters.dangerLevels).forEach(v => $store.filters.dangerLevels[v] = false); updateDataPointsWithFilter()">Ne
                                sélectionner rien</button>
                        </div>
                        <div>
                            {{ range .DangerLevels }}
                            <button
                                class="w3-btn w3-border w3-border-blue w3-margin-right w3-margin-bottom w3-round-large"
                                x-bind:class="$store.filters.dangerLevels['{{ .Value |  escapeSingleQuotes}}'] ? 'w3-blue' : 'w3-white'"
                                @click="$store.filters.dangerLevels['{{ .Value |  escapeSingleQuotes }}'] = !$store.filters.dangerLevels['{{ .Value |  escapeSingleQuotes }}']; updateDataPointsWithFilter()"
                                x-text="'{{ .Name |  escapeSingleQuotes }}'"></button>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="map" class="w3-card w3-margin-top w3-auto w3-round-large"
        style="width: 90vw;height: 70vh;max-width: none;"></div>
    </div>

    <!-- END OF PAGE -->

    <div id="helpModal" class="w3-modal">
        <div class="w3-modal-dialog">
            <div class="w3-modal-content w3-card-8">
                <header class="w3-container w3-teal">
                    <span onclick="document.getElementById('helpModal').style.display='none'"
                        class="w3-button w3-large w3-display-topright">&times;</span>
                    <h2>Soumettre une demande d'aide</h2>
                </header>

                {{ template "forms/helpForm.html" . }}

                <footer class="w3-container w3-teal">
                    <p>Merci pour votre contribution!</p>
                </footer>
            </div>
        </div>
    </div>

    <p>
        <button onclick="document.getElementById('eventModal').style.display='block'"
            class="w3-btn w3-teal w3-round-xlarge" {{ if not .ActiveSession }} disabled title="Veuillez vous connecter"
            {{ end }}>Créer un évènement</button>
    </p>

    <div id="eventModal" class="w3-modal">
        <div class="w3-modal-dialog">
            <div class="w3-modal-content w3-card-8 w3-round-xlarge">
                <header class="w3-container" style="height: 0;">
                    <span onclick="document.getElementById('eventModal').style.display='none'"
                        class="w3-button w3-large w3-display-topright w3-teal w3-margin">&times;</span>
                </header>

                {{ template "forms/eventForm.html" . }}

                <footer class="w3-container w3-teal">
                    <p>Merci pour votre contribution!</p>
                </footer>
            </div>
        </div>
    </div>
</body>

</html>
{{ end }}